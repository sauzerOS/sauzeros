#!/bin/sh -e

# Optimization logic
CONF_ARGS=""
if [ "$HOKUTO_ARCH" = "x86_64" ]; then
    case "$CPUFLAGS" in
        *avx2*) CONF_ARGS="enable-ec_nistp_64_gcc_128" ;;
    esac
fi

./Configure \
    --prefix=$CROSS_PREFIX \
    --openssldir=/etc/ssl \
    --libdir=lib \
    no-unit-test \
    shared \
    $CONF_ARGS \
    linux-$HOKUTO_ARCH

make
make DESTDIR=$1 install

if [ "${CROSS_PREFIX:-}" = "/usr/aarch64-linux-gnu" ]; then
    rm -rf -- "$1/etc"
    rm -rf -- "$1/$CROSS_PREFIX/share"
fi

if [ "$MULTILIB" = "1" ]; then
#32bit
make distclean
./config --prefix=/usr         \
         --openssldir=/etc/ssl \
         --libdir=lib32        \
         shared                \
         zlib-dynamic          \
         linux-x86

make
make DESTDIR=$PWD/DESTDIR install
install -d $1/usr/lib32
cp -Rv DESTDIR/usr/lib32/* $1/usr/lib32
fi
