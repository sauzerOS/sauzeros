#!/bin/sh

# Get the installed kernel version from metadata files
# parsing "hokuto ls" is unreliable due to styling/colors
if [ -f "/var/db/hokuto/installed/linux-cachyos/version" ]; then
    current=$(cat /var/db/hokuto/installed/linux-cachyos/version)
elif [ -f "/var/db/hokuto/installed/linux-cachyos/pkginfo" ]; then
    current=$(grep "^version=" /var/db/hokuto/installed/linux-cachyos/pkginfo | cut -d= -f2)
else
    # Fallback to hokuto ls but strip colors and pick 3rd column
    # Use -r to try to be raw if supported, or just strip ansi
    current=$(hokuto ls linux-cachyos | grep "linux-cachyos" | sed 's/\x1b\[[0-9;]*m//g' | awk '{print $3}')
fi

# Strip revision if present (e.g. 6.18.8-1 -> 6.18.8)
current=$(echo "$current" | sed 's/-[0-9]*$//')

if [ -z "$current" ]; then
    echo "Error: Could not determine installed kernel version. Skipping module cleanup."
    exit 0
fi

echo "Currently installed kernel version: $current"

# Loop through all module directories
for dir in /lib/modules/*; do
    if [ ! -d "$dir" ]; then continue; fi
    base=$(basename "$dir")
    # Check if the directory name STARTs with the current version
    # (Sometimes module dirs have suffixes like -sauzerOS)
    if [[ "$base" == "$current"* ]]; then
        echo "Keeping $dir"
    else
        echo "Removing old modules: $dir"
        rm -rf "$dir"
    fi
done

# Find the matching directory under /lib/modules
match=$(basename $(ls -d /lib/modules/$current*))
echo "Running depmod for $match"
depmod -a "$match"
