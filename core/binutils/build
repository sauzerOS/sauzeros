#!/bin/sh -e

if [ "${HOKUTO_CROSS_SYSTEM:-0}" = "1" ]; then
TARGET_TRIPLET="${HOKUTO_ARCH}-linux-gnu"
sed -i "/ac_cpp=/s/\$CPPFLAGS/\$CPPFLAGS -O2/" libiberty/configure
./configure --target="${TARGET_TRIPLET}" \
              --with-sysroot="${CROSS_PREFIX}" \
              --prefix=/usr \
              --disable-gprofng \
              --disable-multilib \
              --with-gnu-as \
              --with-gnu-ld \
              --disable-nls \
              --enable-gold \
              --enable-ld=default \
              --enable-plugins \
              --enable-deterministic-archives \
              --enable-new-dtags
make
make DESTDIR="$1" install

# Remove file conflicting with host binutils and manpages for MS Windows tools
rm -rf "$1"/usr/{include,lib,share}
else

mkdir -v build
cd       build

if [ "${HOKUTO_CROSS:-0}" = "1" ]; then
    HOST_OPT="--host=${HOKUTO_ARCH}-linux-gnu --build=$(gcc -dumpmachine)"
else
    PGO_OPT="--enable-pgo-build=lto"
fi

../configure --prefix=/usr \
    $HOST_OPT \
    $PGO_OPT \
    --sysconfdir=/etc \
    --with-lib-path=/usr/lib:/usr/local/lib \
    --enable-cet \
    --enable-colored-disassembly \
    --enable-default-execstack=no \
    --enable-deterministic-archives \
    --enable-install-libiberty \
    --enable-ld=default \
    --enable-new-dtags \
    --enable-plugins \
    --enable-relro \
    --enable-shared \
    --enable-threads \
    --disable-gdb \
    --disable-gdbserver \
    --disable-libdecnumber \
    --disable-readline \
    --disable-sim \
    --disable-werror \
    --with-pic \
    --with-system-zlib

make tooldir=/usr
make tooldir=/usr DESTDIR="$1" install

# Fix symlinks for cross-native build (binutils defaults to prefixed names)
if [ "${HOKUTO_CROSS:-0}" = "1" ] && [ "${HOKUTO_CROSS_SYSTEM:-0}" != "1" ]; then
    for f in "$1"/usr/bin/$HOKUTO_ARCH-linux-gnu-*; do
        [ -e "$f" ] || continue
        base=$(basename "$f")
        target=${base#$HOKUTO_ARCH-linux-gnu-}
        # Don't overwrite if it exists (though it shouldn't for a pure cross native pkg)
        ln -sfv "$base" "$1/usr/bin/$target"
    done
fi
fi
