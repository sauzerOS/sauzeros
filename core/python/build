#!/bin/sh -e

# Reported 20-27% performance improvements.
# See: "PythonNoSemanticInterpositionSpeedup"
export CFLAGS="$CFLAGS -fno-semantic-interposition -ffat-lto-objects"
export LDFLAGS="$LDFLAGS -fno-semantic-interposition"

# Use CROSS_PREFIX if set (defaults to /usr in hokuto)
PREFIX="${CROSS_PREFIX:-/usr}"

# Python 3.11+ can use a host python for building
if hokuto check python; then
      OPTS="--with-build-python=python3"
fi

# Determine build strategy
if [[ "${HOKUTO_CROSS:-0}" == "1" ]]; then
    # HOKUTO_ARCH is already normalized to e.g. aarch64/x86_64
    HOST_TRIPLET="${HOKUTO_ARCH}-linux-gnu"
    CROSS_OPTS="--host=$HOST_TRIPLET --build=$(gcc -dumpmachine)"

    # Disable PGO/LTO optimizations during cross-compile as they require running target code
    # We also disable IPv6 because getaddrinfo detection usually fails during cross-compilation
    CROSS_OPTS="$CROSS_OPTS --disable-optimizations --disable-ipv6"

    # Ensure ncursesw headers are found (specifically term.h which is often not included by curses.h)
    export CFLAGS="$CFLAGS -I/usr/${HOST_TRIPLET}/usr/include/ncursesw"
    export CPPFLAGS="$CPPFLAGS -I/usr/${HOST_TRIPLET}/usr/include/ncursesw"

    # Pre-seed some results that cannot be determined when cross-compiling
    export ac_cv_file__dev_ptmx=yes
    export ac_cv_file__dev_ptc=no
else
    CROSS_OPTS="--enable-optimizations"
fi

./configure \
    --prefix="$PREFIX" \
    --enable-shared \
    $CROSS_OPTS \
    $OPTS \
    --with-system-expat \
    --with-system-ffi

make EXTRA_CFLAGS="$CFLAGS -DTHREAD_STACK_SIZE=0x100000"
make DESTDIR=$1 install

ln -sf python3 "$1$PREFIX/bin/python"
if [[ -f "$1$PREFIX/bin/pip3" ]]; then
    ln -sf pip3 "$1$PREFIX/bin/pip"
fi

# Fix shebang in pip scripts (which capture the staging directory path)
# We want them to point to the actual install location (e.g. /usr/bin/python3)
for pip_bin in "$1$PREFIX/bin/pip"*; do
    if [[ -f "$pip_bin" ]]; then
        # Replace the first line if it looks like a python shebang
        sed -i "1s|^#!.*python.*|#!$PREFIX/bin/python3|" "$pip_bin"
    fi
done
