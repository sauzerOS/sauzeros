#!/bin/sh -e

# Use CROSS_PREFIX if set (defaults to /usr in hokuto)
PREFIX="${CROSS_PREFIX:-/usr}"
SYSCONF_DIR="${PREFIX}/etc"
[ "$PREFIX" = "/usr" ] && SYSCONF_DIR="/etc"

meson_options=(
    --prefix="$PREFIX"
    --sysconfdir="$SYSCONF_DIR"
    --sbindir bin
    --libexecdir lib
    --buildtype plain
    -D fs-search-path="$PREFIX/bin:/usr/local/bin"
    -D libuser=disabled
    -D libutempter=disabled
    -D ncurses=disabled
    -D ncursesw=enabled
    -D econf=disabled
    -D build-chfn-chsh=enabled
    -D build-line=disabled
    -D build-mesg=enabled
    -D build-newgrp=enabled
    -D build-vipw=enabled
    -D build-write=enabled
    -D colors-default=true
)

if [ "${HOKUTO_CROSS:-0}" = "1" ]; then
    meson_options+=(--cross-file "$HOKUTO_ARCH")
    if [ "$PREFIX" != "/usr" ]; then
        export PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig:$PREFIX/share/pkgconfig"
    fi
fi

meson setup build "${meson_options[@]}"
meson compile -C build
meson install -C build --destdir="$1"

# remove static libraries
rm -f "$1$PREFIX"/lib/lib*.a*

# install PAM files for login-utils
install -Dm0644 common.pam "${1}$SYSCONF_DIR/pam.d/chfn"
install -Dm0644 common.pam "${1}$SYSCONF_DIR/pam.d/chsh"
install -Dm0644 login.pam  "${1}$SYSCONF_DIR/pam.d/login"
install -Dm0644 remote.pam "${1}$SYSCONF_DIR/pam.d/remote"
install -Dm0644 runuser.pam "${1}$SYSCONF_DIR/pam.d/runuser"
install -Dm0644 runuser.pam "${1}$SYSCONF_DIR/pam.d/runuser-l"
install -Dm0644 su.pam      "${1}$SYSCONF_DIR/pam.d/su"
install -Dm0644 su.pam      "${1}$SYSCONF_DIR/pam.d/su-l"

if [ -f "${1}$PREFIX/lib/systemd/system/uuidd.socket" ]; then
    sed -i '/ListenStream/ aRuntimeDirectory=uuidd' "${1}$PREFIX/lib/systemd/system/uuidd.socket"
fi

# install systemd-sysusers
install -Dm0644 util-linux.sysusers \
  "${1}$PREFIX/lib/sysusers.d/util-linux.conf"

install -Dm0644 60-rfkill.rules \
  "${1}$PREFIX/lib/udev/rules.d/60-rfkill.rules"

install -Dm0644 rfkill-unblock_.service \
  "${1}$PREFIX/lib/systemd/system/rfkill-unblock@.service"
install -Dm0644 rfkill-block_.service \
  "${1}$PREFIX/lib/systemd/system/rfkill-block@.service"

if [ "${HOKUTO_CROSS:-0}" != "1" ] && [ "$MULTILIB" = "1" ]; then
#32bit
rm -rf build

meson_options_32=(
    --prefix=/usr
    --libexecdir /usr/lib32
    --libdir     /usr/lib32
    --auto-features disabled
    -D build-libblkid=enabled
    -D build-libuuid=enabled
    -D build-libmount=enabled
    -D build-libsmartcols=enabled
    -D build-libfdisk=enabled
    -D ncurses=disabled
    -D ncursesw=enabled
)

export CC="gcc -m32"
export CXX="g++ -m32"
export PKG_CONFIG_PATH="/usr/lib32/pkgconfig"

meson setup build "${meson_options_32[@]}" --cross-file lib32
meson compile -C build
meson install -C build --destdir=$PWD/DESTDIR
install -d $1/usr/lib32
cp -Rv DESTDIR/usr/lib32/* $1/usr/lib32
fi
