#!/bin/sh -e

meson setup build       \
  --prefix=/usr         \
  --buildtype=release   \
  -D docs=disabled

meson compile -C build
meson install -C build --destdir=$1

# environment file for ssh-agent
install -v -m 644 environment "$1/etc/environment"

install -v -m 755 -d "$1/etc/pam.d"
install -v -m 644 other "$1/etc/pam.d/other"
install -v -m 644 system-auth "$1/etc/pam.d/system-auth"
install -v -m 644 system-local-login "$1/etc/pam.d/system-local-login"
install -v -m 644 system-login "$1/etc/pam.d/system-login"
install -v -m 644 system-remote-login "$1/etc/pam.d/system-remote-login"
install -v -m 644 system-services "$1/etc/pam.d/system-services"

install -Dm 644 $3.tmpfiles "${1}"/usr/lib/tmpfiles.d/${3}.conf

if [ "$MULTILIB" = "1" ]; then
#32bit
rm -rf build
PKG_CONFIG_PATH="/usr/lib32/pkgconfig" \
CC="gcc -m32 -march=i686"              \
CXX="g++ -m32 -march=i686"             \
meson setup build       \
    --prefix=/usr       \
    --libdir=/usr/lib32 \
    --buildtype=release \
    -D docs=disabled

meson compile -C build
meson install -C build --destdir=$PWD/DESTDIR
install -d $1/usr/lib32
cp -Rv DESTDIR/usr/lib32/* $1/usr/lib32
fi
