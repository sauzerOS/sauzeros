#!/bin/sh -e

# Use CROSS_PREFIX if set (defaults to /usr in hokuto)
PREFIX="${CROSS_PREFIX:-/usr}"
SYSCONF_DIR="${PREFIX}/etc"
[ "$PREFIX" = "/usr" ] && SYSCONF_DIR="/etc"

meson_options=(
    --prefix="$PREFIX"
    --sysconfdir="$SYSCONF_DIR"
    --buildtype=release
    -D docs=disabled
)

if [ "${HOKUTO_CROSS:-0}" = "1" ]; then
    if [ "$PREFIX" = "/usr" ]; then
        meson_options+=(
            --cross-file "${HOKUTO_ARCH}"
        )
    else
        meson_options+=(--cross-file "$HOKUTO_ARCH")
        if [ "$PREFIX" != "/usr" ]; then
            export PKG_CONFIG_PATH="$PREFIX/lib/pkgconfig:$PREFIX/share/pkgconfig"
        fi
    fi
fi

meson setup build "${meson_options[@]}"
meson compile -C build
meson install -C build --destdir="$1"

# Fix incorrect paths from cross-compilation
if [ "${HOKUTO_CROSS:-0}" = "1" ] && [ "$PREFIX" = "/usr" ]; then
    if [ -d "$1$PREFIX/$HOKUTO_ARCH-linux-gnu" ]; then
        echo "Moving files from sysroot $1$PREFIX/$HOKUTO_ARCH-linux-gnu to $1$PREFIX"
        cp -rl "$1$PREFIX/$HOKUTO_ARCH-linux-gnu/"* "$1$PREFIX/"
        rm -rf "$1$PREFIX/$HOKUTO_ARCH-linux-gnu"
    fi
fi

if [ "${CROSS_PREFIX:-/usr}" = "/usr" ]; then
# environment file for ssh-agent
install -vDm 644 environment "$1/etc/environment"

install -v -m 755 -d "$1/etc/pam.d"
install -v -m 644 other               "$1/etc/pam.d/other"
install -v -m 644 system-auth          "$1/etc/pam.d/system-auth"
install -v -m 644 system-local-login   "$1/etc/pam.d/system-local-login"
install -v -m 644 system-login         "$1/etc/pam.d/system-login"
install -v -m 644 system-remote-login  "$1/etc/pam.d/system-remote-login"
install -v -m 644 system-services      "$1/etc/pam.d/system-services"

install -Dm 644 "$3.tmpfiles" "$1/usr/lib/tmpfiles.d/$3.conf"
fi

if [ "${HOKUTO_CROSS:-0}" != "1" ] && [ "$MULTILIB" = "1" ]; then
#32bit
rm -rf build
PKG_CONFIG_PATH="/usr/lib32/pkgconfig" \
CC="gcc -m32 -march=i686"              \
CXX="g++ -m32 -march=i686"             \
meson setup build       \
    --prefix=/usr       \
    --libdir=/usr/lib32 \
    --buildtype=release \
    -D docs=disabled

meson compile -C build
meson install -C build --destdir=$PWD/DESTDIR
install -d $1/usr/lib32
cp -Rv DESTDIR/usr/lib32/* $1/usr/lib32
fi
