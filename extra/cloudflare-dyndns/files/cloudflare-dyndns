#!/bin/bash

# --- Configuration ---
TOKEN="your_api_token"
ZONE_ID="your_zone_id"
RECORD_NAME="example.com"  # e.g., "home.yourdomain.com" or "yourdomain.com"

# Cache files
IP_FILE="/var/tmp/last_cloudflare_ip.txt"
ID_FILE="/var/tmp/cloudflare_record_id.txt"

# --- 1. Get or Fetch Record ID ---
if [[ -f "$ID_FILE" ]]; then
    RECORD_ID=$(cat "$ID_FILE")
else
    echo "Record ID not cached. Fetching from Cloudflare..."
    RECORD_ID=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records?type=A&name=$RECORD_NAME" \
         -H "Authorization: Bearer $TOKEN" \
         -H "Content-Type: application/json" | jq -r '.result[0].id')

    if [[ "$RECORD_ID" != "null" && -n "$RECORD_ID" ]]; then
        echo "$RECORD_ID" > "$ID_FILE"
        echo "Fetched and saved Record ID: $RECORD_ID"
    else
        echo "Error: Could not find A record for $RECORD_NAME. Check your Zone ID and Token."
        exit 1
    fi
fi

# --- 2. Get current public IP ---
CURRENT_IP=$(curl -s https://api.ipify.org || curl -s https://ifconfig.me)

if [[ -z "$CURRENT_IP" ]]; then
    echo "Error: Could not retrieve public IP."
    exit 1
fi

# --- 3. Check against cached IP ---
if [[ -f "$IP_FILE" ]]; then
    OLD_IP=$(cat "$IP_FILE")
    if [[ "$CURRENT_IP" == "$OLD_IP" ]]; then
        exit 0 # IP hasn't changed
    fi
fi

# --- 4. Update Cloudflare ---
RESPONSE=$(curl -s -X PATCH "https://api.cloudflare.com/client/v4/zones/$ZONE_ID/dns_records/$RECORD_ID" \
     -H "Authorization: Bearer $TOKEN" \
     -H "Content-Type: application/json" \
     --data "{\"content\": \"$CURRENT_IP\"}")

# --- 5. Verify and update IP cache ---
if [[ "$RESPONSE" == *"\"success\":true"* ]]; then
    echo "$CURRENT_IP" > "$IP_FILE"
    echo "IP successfully updated to $CURRENT_IP"
else
    echo "Cloudflare update failed. Response: $RESPONSE"
    # If unauthorized, delete ID_FILE so it re-fetches next time
    [[ "$RESPONSE" == *"\"code\":6003"* ]] && rm "$ID_FILE"
    exit 1
fi
