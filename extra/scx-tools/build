#!/bin/sh -e

export RUSTUP_TOOLCHAIN=stable
cargo fetch --locked --target "$(rustc -vV | sed -n 's/host: //p')"
export CARGO_TARGET_DIR=target
cargo build --release --frozen --all-features --workspace

# Install all built executables (skip .so and .d files)
find target/release \
  -maxdepth 1 -type f -executable ! -name '*.so' ! -name 'xtask' \
  -exec install -Dm755 -t "$1/usr/bin/" {} +

# Install runtime assets via xtask
# (systemd units, D-Bus services, configs, sample files)
./target/release/xtask install --destdir "$1"
