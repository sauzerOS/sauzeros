#!/bin/sh -e

grep -rl '^#!.*python$' | xargs sed -i '1s/python/&3/'

CXXFLAGS+="-O2 -fPIC"             \
meson setup -B build              \
      --prefix=/usr               \
      --buildtype=release         \
      -D libaudit=no              \
      -D nmtui=false              \
      -D ppp=false                \
      -D selinux=false            \
      -D qt=false                 \
      -D session_tracking=systemd \
      -D modem_manager=false

meson compile -C build
DESTDIR=$1 meson install -C build

install  -Dm 644 NetworkManager.conf "$1/etc/NetworkManager/NetworkManager.conf"
install -Dm 644 no-dns-update.conf  "$1/etc/NetworkManager/conf.d/no-dns-update.conf"
install -Dm 644 polkit.conf "$1/etc/NetworkManager/conf.d/polkit.conf"
install -Dm 644 org.freedesktop.NetworkManager.rules "$1/usr/share/polkit-1/rules.d/org.freedesktop.NetworkManager.rules"
