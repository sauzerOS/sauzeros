#!/bin/sh

cd firefox-$2

cat > .mozconfig << EOF
ac_add_options --enable-application=browser
ac_add_options --prefix=/usr
ac_add_options --enable-release
ac_add_options --enable-hardening
ac_add_options --enable-optimize
ac_add_options --enable-rust-simd
ac_add_options --enable-linker=lld
ac_add_options --disable-install-strip
ac_add_options --disable-bootstrap
ac_add_options --enable-lto=thin
ac_add_options --without-wasm-sandboxed-libraries
# Branding
ac_add_options --enable-official-branding
ac_add_options --enable-update-channel=release
ac_add_options --with-unsigned-addon-scopes=app,system
ac_add_options --allow-addon-sideload
# Keys
#ac_add_options --with-google-location-service-api-keyfile=${PWD@Q}/google-api-key
#ac_add_options --with-google-safebrowsing-api-keyfile=${PWD@Q}/google-api-key

# System libraries
ac_add_options --with-system-nspr
ac_add_options --with-system-nss
#ac_add_options --with-system-av1
ac_add_options --with-system-libvpx
ac_add_options --with-system-webp
ac_add_options --with-system-png
ac_add_options --with-system-icu
ac_add_options --with-system-jpeg
ac_add_options --with-system-pipewire


# Features
ac_add_options --disable-updater
ac_add_options --disable-tests
EOF

# LTO
#WARNING_FLAGS="-Werror=odr -Werror=strict-aliasing"
COMMON_FLAGS="-march=native -O2 -flto=thin -pipe ${WARNING_FLAGS}"
CFLAGS="${COMMON_FLAGS}"
CXXFLAGS="${COMMON_FLAGS}"
FCFLAGS="${COMMON_FLAGS}"
FFLAGS="${COMMON_FLAGS}"

RUSTFLAGS="-C target-cpu=native -C strip=debuginfo -C opt-level=3 \
-Clinker=clang -Clinker-plugin-lto -Clink-arg=-fuse-ld=lld"

LDFLAGS="${COMMON_FLAGS} ${LDFLAGS} -fuse-ld=lld"
CC="clang"
CXX="clang++"
CPP="clang-cpp"
AR="llvm-ar"
NM="llvm-nm"
RANLIB="llvm-ranlib"

export MOZILLA_OFFICIAL=1
export MOZ_NOSPAM=1
export RUST_MIN_STACK=16777216
ulimit -n 4096

export MACH_BUILD_PYTHON_NATIVE_PACKAGE_SOURCE=none
export MOZBUILD_STATE_PATH=${PWD}/mozbuild

./mach build $MAKEFLAGS --priority normal

export MACH_BUILD_PYTHON_NATIVE_PACKAGE_SOURCE=none
DESTDIR=$1 ./mach install

# Desktop file & icon
install -d $1/usr/share/applications
install -d $1/usr/share/icons/hicolor/symbolic/apps
install -Dvm644 ../firefox.desktop $1/usr/share/applications/
install -Dvm644 ../firefox-symbolic.svg -t "$1/usr/share/icons/hicolor/symbolic/apps"

# Install desktop icons and metadata
theme=official
for i in 16 22 24 32 48 64 128 256; do
install -Dvm644 browser/branding/$theme/default$i.png \
"$1/usr/share/icons/hicolor/${i}x${i}/apps/firefox.png"
done
install -Dvm644 browser/branding/$theme/content/about-logo.png \
"$1/usr/share/icons/hicolor/192x192/apps/firefox.png"
install -Dvm644 browser/branding/$theme/content/about-logo@2x.png \
"$1/usr/share/icons/hicolor/384x384/apps/firefox.png"
install -Dvm644 browser/branding/$theme/content/about-logo.svg \
"$1/usr/share/icons/hicolor/scalable/apps/firefox.svg"

