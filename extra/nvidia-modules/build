#!/bin/sh -e

unset LDFLAGS CFLAGS CXXFLAGS

# disable RT CHECK
#export IGNORE_PREEMPT_RT_PRESENCE=1

patch -p1 -d kernel-open -i ../gpl.patch

# 6.18 fix
patch -Np1 -i 951.patch

# Build and install kernel modules
export SYSSRC=/usr/src/linux/
export SYSOUT=/usr/src/linux/

# Get the kernel version from the source tree (not the running kernel)
KERNEL_VERSION=$(make -s -C /usr/src/linux kernelrelease)

# Build modules against the target kernel
make modules -j$(nproc)

# Install to the target kernel's module directory
mkdir -p "$1/lib/modules/${KERNEL_VERSION}/kernel/drivers/video"
cp kernel-open/*.ko "$1/lib/modules/${KERNEL_VERSION}/kernel/drivers/video/"

install -d $1/etc/modprobe.d
cp nvidia.conf $1/etc/modprobe.d/
