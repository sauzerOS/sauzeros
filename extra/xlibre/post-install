#!/bin/sh -e

XORG_CONF="/etc/X11/xorg.conf"

# Check if xorg.conf exists
if [ -f "$XORG_CONF" ]; then
    # Check if IgnoreABI is already present
    if ! grep -q 'Option[[:space:]]\+"IgnoreABI"[[:space:]]\+"1"' "$XORG_CONF"; then
        echo "Adding IgnoreABI option to $XORG_CONF"

        # Append the ServerFlags section if not present
        if ! grep -q 'Section[[:space:]]\+"ServerFlags"' "$XORG_CONF"; then
            cat <<EOF >> "$XORG_CONF"

# nvidia xlibre fix
Section "ServerFlags"
    Option "IgnoreABI" "1"
EndSection
EOF
        else
            # Insert the option inside the existing ServerFlags section
            sed -i '/Section[[:space:]]\+"ServerFlags"/a\    Option "IgnoreABI" "1"' "$XORG_CONF"
        fi
    fi
else
    # If xorg.conf doesn't exist, create it with the required section.
    echo "$XORG_CONF not found. Creating it with the nvidia xlibre fix"
    cat <<EOF > "$XORG_CONF"
# nvidia xlibre fix
Section "ServerFlags"
    Option "IgnoreABI" "1"
EndSection
EOF
fi
