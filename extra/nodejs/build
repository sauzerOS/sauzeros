#!/bin/sh -e

# Node.js configure expects specific names for CPUs
# mapping: aarch64 -> arm64, x86_64 -> x64
DEST_CPU="$HOKUTO_CARCH"
if [ -z "$DEST_CPU" ]; then
    DEST_CPU=$(uname -m)
fi

case "$DEST_CPU" in
    x86_64)  DEST_CPU="x64" ;;
    aarch64) DEST_CPU="arm64" ;;
esac

# Common configure arguments
CONF_ARGS="--prefix=$CROSS_PREFIX \
           --shared-libuv \
           --shared-nghttp2 \
           --shared-zlib \
           --shared-openssl \
           --shared-brotli \
           --with-intl=system-icu"

if [ "${HOKUTO_CROSS:-0}" = "1" ]; then
    # Host tools configuration
    export CC_host=gcc
    export CXX_host=g++
    export AR_host=ar
    export LINK_host=g++
    
    # Target tools configuration
    # HOKUTO sets CC and CXX already
    export LINK="$CXX"

    ./configure $CONF_ARGS \
        --dest-cpu="$DEST_CPU" \
        --dest-os=linux \
        --cross-compiling
else
    # Regular native build
    ./configure $CONF_ARGS
fi

make
# Debug built files location
find out -name node -type f

make install DESTDIR="$1"
